<%= render "social_networking/shared/nav" %>

<div class="modal-container">
  <div class="modal fade" id="profile-icon-selection" tabindex="-1" role="dialog" aria-labelledby="icon-modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <h3 id="icon-modal">Choose a profile icon:</h3>
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        </div>

        <div class="modal-body">
          <% @profile_icons.each_with_index do |icon_name, index| %>
              <% if 0 == index % 6 %><div class="row" style="margin-top: 20px;"><% end %>
              <div class="col-lg-2 col-sm-2 col-xs-2 text-center" style="padding-top: 5px; padding-bottom: 5px;<% if 1 == index %>border: 2px dotted #eee;<% end %>">
                <%= image_tag 'social_networking/profile_icon_'+ icon_name +'.png', :size => '48' %>
              </div>
              <% if 5 == index % 6 || index + 1 == @profile_icons.size %></div><% end %>
          <% end %>
        </div>

      </div>
    </div>
  </div>
</div>

<div ng-controller="ProfileCtrl as profile">
  <div class="text-center" id="profile-box">
    <a href="#" data-toggle="modal" data-target="#profile-icon-selection">
      <% if @profile.icon_name.nil? || @profile.icon_name.blank? %>
          <%= image_tag ('social_networking/profile_icon_questionmark.png') %>
      <% else %>
          <%= image_tag ('social_networking/profile_icon_' + @profile.icon_name + '.png') %>
      <% end %>
    </a>
    
  <div class="profiles-username">
    <h2><%= @profile.user_name %></h2>
  </div>
  <div class="profiles-last-online">
    <h3>Last seen: {{ '<%= @profile.latest_action_at %>' | timeFromNow }}</h3>
  </div>

  <% if current_participant.id != @profile.participant_id %>
    <div id="profile-nudge">
      <a href="" ng-click="profile.nudge()">Nudge</a>
    </div>
  <% end %>
  </div>
</div>

<% if current_participant.id == @profile.participant_id && !@nudges.empty? %>
    <div class="alert alert-info" id="nudge-alert">
      <button type="button" class="close" data-dismiss="alert" onclick="$('#nudge-alert').hide();"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      <%= @nudges.to_sentence %> buzzed you!
    </div>
<% end %>

<h3>Profile Questions</h3>

<ul class="list-group" ng-controller="ProfileQuestionsCtrl as profileQuestions">
  <div ng-controller="ProfileAnswerCtrl as answer">
    <li ng-repeat="question in profileQuestions.questions | orderBy:'order'" class="list-group-item" id="question-{{ question.id }}" ng-init="answer.storeAnswer(<%= @profile.id %>, question.id, answer)">
      <label> {{ question.question_text }} </label>

      <form novalidate role="form" name="answerForm" class="row" ng-show="answer._answerStates[question.id].editable">

        <input type="hidden" name="profile_question_id" value="{{ question.id }}" ng-if="answer.answerModels[question.id].id === null">
        <input type="hidden" name="profile_id" value="<%= @profile.id %>" ng-if="answer.answerModels[question.id].id === null">
        <input type="hidden" name="id" ng-if="answer.answerModels[question.id].id !== null">

        <div class="form-group col-lg-8 col-md-8">
          <input type="text" class="form-control" id="new-answer-description-{{question.id}}" ng-model="answer.answerModels[question.id].answer_text" ng-maxlength="255">
        </div>

        <div class="form-group col-lg-8 col-md-8">
          <button class="btn btn-primary" ng-click="answer.save(<%= @profile.id %>, question.id, answer)">Save</button>
          <button class="btn btn-default" ng-click="answer.cancelEdit(question.id, answer)">Cancel</button>
        </div>

      </form>

      <div class="list-group" ng-show="!answer._answerStates[question.id].editable">
        <label>
          {{ answer.answerModels[question.id].answer_text }}
        </label>

        <% if current_participant.id == @profile.participant_id %>
        <div class="form-group">
          <button class="btn btn-link pull-right edit" ng-click="answer.edit(question.id, answer)"><i class="fa fa-pencil"></i></button>
        </div>
        <% end %>
      </div>
    </li>
  </div>
</ul>

<div ng-controller="HomeCtrl as feed">
  <ul class="list-group">
    <li ng-repeat="item in feed.feedItems | orderBy:'createdAt':true"
        class="list-group-item"
        id="{{ item.className }}-{{ item.id }}">
      <p>{{ item.summary }}</p>
    </li>
  </ul>
</div>

<!-- bootstrap Angular app with current participant id -->
<script>
  angular.module('socialNetworking')
          .value('participantId', <%= current_participant.id %>)
          .value('profileId', <%= @profile.id %>)
          .value('ProfileQuestions', <%= @profile_questions.to_json.html_safe %>)
          .value('actionItems', [])
          .value('memberProfiles', [])
          .value('feedItems', <%= @feed_items.to_json.html_safe %>);          
  $('.modal-container .modal').appendTo($("body"));
</script>
