<div ng-controller="ProfileCtrl as profile" ng-cloak>
  <div class="modal-container">
    <div class="modal fade" id="profile-icon-selection" tabindex="-1" role="dialog" aria-labelledby="icon-modal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="icon-modal">
              <div ng-if="<%=@profile.icon_name.nil?%>">Start creating your profile by choosing a profile icon:</div>
              <div ng-if="<%=!@profile.icon_name.nil?%>">Choose a new profile icon:</div>
            </h3>
            <button type="button" class="close hidden" data-dismiss="modal" aria-hidden="true" id="icon-selection-button">Ã—</button>
          </div>

          <div class="modal-body">
            <% @profile_icons.each_with_index do |icon_name, index| %>
              <% if 0 == index % 6 %><div class="row"><% end %>
              <div ng-click="profile.update_profile_icon('<%= icon_name %>', profile)" class="col-lg-2 col-sm-4 col-xs-4 text-center icon-selection">
                <%= image_tag 'social_networking/profile_icon_'+ icon_name +'.png' %>
              </div>
              <% if 5 == index % 6 || index + 1 == @profile_icons.size %></div><% end %>
            <% end %>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="text-center" id="profile-box">
    <div class="profile-box-content profile-box-border">
      <% if current_participant.id == @profile.participant_id %>
        <a href="" data-toggle="modal" data-target="#profile-icon-selection" id="profile-icon-selector">
      <% end %>

      <img ng-src="{{ profile.profile.iconSrc }}" id="profile-icon">

      <% if current_participant.id == @profile.participant_id %>
        </a>
      <% end %>

      <div class="profiles-username">
        <h3>{{ profile.profile.username }}</h3>
      </div>
    </div>

    <div class="profiles-last-online profile-box-border">
      <h3>Last seen: {{ profile.profile.latestAction | timeFromNow }}</h3>
    </div>

    <% if current_participant.id != @profile.participant_id %>
      <div class="profiles-nudge profile-box-border">
        <a href="" id="nudge-link" ng-click="profile.nudge(<%= @profile.participant_id %>)">Nudge</a>
        <br><span>{{ profile.nudgeAlert }}</span>
      </div>
    <% end %>
  </div>
</div>

<% if current_participant.id == @profile.participant_id %>
  <% unless @nudges.empty? %>
    <div class="alert alert-info" id="nudge-alert">
      <button type="button" class="close" data-dismiss="alert" onclick="$('#nudge-alert').hide();"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      <%= @nudges.to_sentence %> nudged you!
    </div>
  <% end %>

  <div ng-controller="ProfileQuestionsCtrl as profileQuestions">
    <div ng-controller="ProfileAnswerCtrl as answer">
      <h3 ng-hide="answer.ifAnswered(profileQuestions.questions)">
        Fill out your profile so other group members can get to know you!
      </h3>
      <ul class="list-group">
        <li ng-repeat="question in profileQuestions.questions | orderBy:'order'"
            class="list-group-item"
            id="question-{{ question.id }}"
            ng-init="answer.storeAnswer(<%= @profile.id %>, question.id)">
          <label for="new-answer-description-{{ question.id }}">{{ question.question_text }}</label>

          <form novalidate role="form" name="answerForm" class="row" ng-show="answer._answerStates[question.id].editable">
            <input type="hidden" name="profile_question_id" value="{{ question.id }}" ng-if="answer.answerModels[question.id].id === null">
            <input type="hidden" name="profile_id" value="<%= @profile.id %>" ng-if="answer.answerModels[question.id].id === null">
            <input type="hidden" name="id" ng-if="answer.answerModels[question.id].id !== null">

            <div class="form-group col-lg-8 col-md-8">
              <input type="text" class="form-control" id="new-answer-description-{{question.id}}" ng-model="answer.answerModels[question.id].answer_text" ng-maxlength="255">
            </div>

            <div class="form-group col-lg-8 col-md-8">
              <button class="btn btn-primary" ng-click="answer.save(<%= @profile.id %>, question.id)">Save</button>
            </div>
          </form>

          <div class="list-group" ng-show="!answer._answerStates[question.id].editable">
            <p>
              {{ answer.answerModels[question.id].answer_text }}
            </p>

            <div class="form-group edit-link">
              <button class="btn btn-link pull-right edit" ng-click="answer.edit(question.id)"><i class="fa fa-pencil"></i></button>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
<% else %>
  <ul class="list-group" ng-controller="ProfileQuestionsCtrl as profileQuestions">
    <div ng-controller="ProfileAnswerCtrl as answer">
      <li ng-repeat="question in profileQuestions.questions | orderBy:'order'" class="list-group-item" ng-init="answer.storeAnswer(<%= @profile.id %>, question.id)">
        <strong>{{ question.question_text }}</strong>

        <div>
          {{ answer.answerModels[question.id].answer_text }}
        </div>
      </li>
    </div>
  </ul>
<% end %>

<div ng-controller="HomeCtrl as home">
  <%= render "social_networking/shared/comment_form" %>

  <ul class="list-group">
    <li ng-repeat="item in home.feedItems | orderBy:'createdAt':true"
        ng-show="home.inFeedBrowseMode()"
        class="list-group-item"
        id="{{ item.className }}-{{ item.id }}">
      <p>
        <div class="media feed-item-displayname">
          <div ng-if="item.isAdmin" class="media-left">
            <img class="feed-participant-icon" ng-if="item.isAdmin" ng-src="{{ home.profileIconSrcFor(item) }}"> 
          </div>
          <div class="media-body">
            <strong>{{ home.profileDisplayNameFor(item) }}</strong> {{ item.summary }}
          </div>
        </div>
      </p>

      <div class="actions">
        <a href="" ng-if="home.canAddLikeTo(item)" class="like" title="like this item" ng-click="home.addLikeTo(item)">
          Like ({{!!item.likes.length ? item.likes.length : 0}})
        </a>
        <a href="" ng-if="!home.canAddLikeTo(item)&&!!item.likes.length" class="likes"  title="show who likes this feed item" ng-click="item.showLikes = !item.showLikes">
          Like ({{item.likes.length}})
        </a>
        <span ng-if="home.canAddLikeTo(item) || !!item.likes.length">&nbsp;|&nbsp;</span>
        <a href="" class="comments" title="view comments" ng-click="item.showComments = !item.showComments">
          Comment ({{ item.comments.length ? item.comments.length : 0}})
        </a>
        <span ng-if="home.hasSummary(item)">&nbsp;|&nbsp;</span>
        <a href="" ng-if="home.hasSummary(item)" title="view details" ng-click="item.showSummary = !item.showSummary">
          <span ng-if="!item.showSummary">More</span>
          <span ng-if="!!item.showSummary">Less</span>
        </a>
      </div>

      <div class="media" ng-if="home.hasSummary(item)" ng-show="!!item.showSummary">
        <div class="media-left"></div>
        <div class="media-body" ng-include src="item.templatePath + '/_summary.html'">
          
        </div>
      </div>

      <div class="media" ng-show="!!item.showLikes">
        <div class="media-left"></div>
        <div class="media-body">
          <p>
            Liked by: <span ng-repeat="like in item.likes">{{ like.participantDisplayName }} </span>
          </p>
        </div>
      </div>

      <div class="media comment text-muted" ng-show="!!item.showComments" ng-repeat="comment in item.comments">
        <div class="media-left">
          <img class="feed-participant-icon" ng-if="comment.isAdmin" ng-src="{{ home.profileIconSrcFor(comment) }}">
        </div>
        <div class="media-body">
          <strong>{{ home.profileDisplayNameFor(comment) }}</strong>: {{ comment.text }}
        </div>
      </div>

      <div class="media">
        <a href="" ng-show="!!item.showComments" ng-click="home.commentOn(item)">
          Add Comment
        </a>
      </div>

      <div class="media" ng-show="home.isCommentingOn(item)">
        <div class="media-left"></div>
        <div class="media-body">
          <form novalidate role="form">
            <div class="form-group">
              <label for="comment-text">What do you think?</label>
              <input type="text" class="form-control" id="comment-text" ng-model="home.commentModel.text" ng-maxlength="255" required focus-on="new-comment">
            </div>

            <div class="form-group">
              <button class="btn btn-primary" ng-click="home.saveComment()" ng-disabled="commentOnForm.$invalid">Save</button>
              <button class="btn btn-default" ng-click="home.closeCommentForm()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </li>
  </ul>

</div>

<form accept-charset="UTF-8" action="/social_networking/profile_icons" id="icon_change" method="post">
  <input id="profile_id" name="profile[profile_id]" type="hidden" value="<%= @profile.id %>"/>
  <input id="icon_name" name="profile[icon_name]" type="hidden" value="<%= @profile.icon_name %>"/>
</form>

<!-- bootstrap Angular app with current participant id -->
<script>
  angular.module('socialNetworking')
          .value('participantId', <%= current_participant.id %>)
          .value('profileId', <%= @profile.id %>)
          .value('ProfileQuestions', <%= @profile_questions.to_json.html_safe %>)
          .value('actionItems', [])
          .value('memberProfiles', <%= @member_profiles.to_json.html_safe %>)
          .value('feedItems', <%= @feed_items.to_json.html_safe %>)
          .value('noticesEnabled', <%= Rails.configuration.enable_notices %>)
          .value('noticeUtility', Notice);

  function onReady() {
    if (<%= @profile.participant_id == current_participant.id %> && <%= @profile.icon_name.nil? %>) {
      $('#profile-icon-selection').modal('show');
    }
  }

  $(document).on("ready page:load page:change", onReady);
</script>
